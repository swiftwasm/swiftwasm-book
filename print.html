<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Swift and WebAssembly</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-cf24db63.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-e5be467c.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Swift and WebAssembly</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Welcome to the SwiftWasm Documentation!</p>
<p><a href="https://github.com/swiftwasm">SwiftWasm is an open source project to support the WebAssembly target for Swift.</a></p>
<p>The goal of this project is to fully support the WebAssembly target for <a href="https://swift.org">Swift</a> and to be merged into <a href="https://github.com/apple/swift">the upstream repository</a>.</p>
<p>WebAssembly is described on its <a href="https://webassembly.org/">home page</a> as:</p>
<blockquote>
<p>WebAssembly (abbreviated as Wasm) is a binary instruction format for a stack-based virtual machine. Wasm is designed as a portable compilation target for programming languages, enabling deployment on the web for client and server applications.</p>
</blockquote>
<p>We use LLVM as a compiler backend to produce WebAssembly binaries. Our resulting binaries also depend on <a href="https://wasi.dev">WASI</a>, which is a modular system interface for WebAssembly. WASI is mainly required to compile Swift Standard Library.</p>
<h3 id="important-note"><a class="header" href="#important-note">Important note</a></h3>
<p>In 2024, Apple introduced <a href="https://github.com/swiftlang/swift/blob/main/docs/EmbeddedSwift/UserManual.md">Swift Embedded</a>.
While both projects benefit from each other, it is important to understand that they are different targets at the build phase, consequentially with different sets of abilities.
Embedded Swift <a href="https://github.com/swiftlang/swift/blob/main/docs/EmbeddedSwift/EmbeddedSwiftStatus.md#embedded-swift-language-features">very limited</a> but can produce small binaries. <a href="https://github.com/apple/swift-for-wasm-examples">Example</a>.</p>
<h2 id="project-status"><a class="header" href="#project-status">Project Status</a></h2>
<p><a href="https://forums.swift.org/t/stdlib-and-runtime-tests-for-wasm-wasi-now-available-on-swift-ci/70385">All compiler and standard library changes have been upstreamed to the official Swift repository, and the upstream CI is now testing WebAssembly targets.</a></p>
<p>The remaining works are:</p>
<ul>
<li>Integrating the build system with the official Swift CI.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<p>This is a getting started guide section to use SwiftWasm.</p>
<p>You can learn about:</p>
<ul>
<li>How to set up a Swift toolchain for compiling to WebAssembly</li>
<li>How to compile a simple Swift code and Swift Package into WebAssembly</li>
<li>How to interoperate with JavaScript</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>Now Swift SDK for WebAssembly is available from the official Swift project.
See the <a href="https://www.swift.org/documentation/articles/wasm-getting-started.html">Swift.org article</a> for instructions on how to install it.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="porting-code-to-webassembly-with-wasi"><a class="header" href="#porting-code-to-webassembly-with-wasi">Porting code to WebAssembly with WASI</a></h1>
<p>In the form that‚Äôs currently standardized and supported by browsers and other hosts, WebAssembly
is a 32-bit architecture. You have to take this into account when porting code from other
platforms, since <code>Int</code> type is a signed 32-bit integer, and <code>UInt</code> is an unsigned 32-bit integer
when building with SwiftWasm. You‚Äôll need to audit codepaths that cast 64-bit integers to <code>Int</code>
or <code>UInt</code>, and a good amount of cross-platform test coverage can help with that.</p>
<p>Additionally, there a differences in APIs exposed by the standard C library and Swift core
libraries which we discuss in the next few subsections.</p>
<h2 id="wasilibc-module"><a class="header" href="#wasilibc-module"><code>WASILibc</code> module</a></h2>
<p>When porting existing projects from other platforms to SwiftWasm you might stumble upon code that
relies on importing a platform-specific <a href="https://en.wikipedia.org/wiki/C_standard_library">C
library</a> module directly. It looks like <code>import Glibc</code> on Linux, or <code>import Darwin</code> on Apple platforms. Fortunately, most of the standard C library
APIs are available when using SwiftWasm, you just need to use <code>import WASILibc</code> to get access to it.
Most probably you want to preserve compatibility with other platforms, thus your imports would look
like this:</p>
<pre><code class="language-swift">#if canImport(Darwin)
import Darwin
#elseif canImport(Glibc)
import Glibc
#elseif canImport(WASILibc)
import WASILibc
#endif
</code></pre>
<h3 id="limitations"><a class="header" href="#limitations">Limitations</a></h3>
<p>WebAssembly and <a href="https://wasi.dev/">WASI</a> provide a constrained environment, which currently does
not directly support multi-threading. Thus, you should not
expect these APIs to work when importing <code>WASILibc</code>. Please be aware of these limitations when
porting your code, which also has an impact on what <a href="#swift-foundation-and-dispatch">can be supported in the Swift
Foundation</a> at the moment.</p>
<h2 id="swift-foundation-and-dispatch"><a class="header" href="#swift-foundation-and-dispatch">Swift Foundation and Dispatch</a></h2>
<p><a href="https://swift.org/core-libraries/#foundation">The Foundation core library</a> is available in
SwiftWasm, but in a limited capacity. The main reason is that <a href="https://swift.org/core-libraries/#libdispatch">the Dispatch core
library</a> is unavailable due to <a href="https://github.com/swiftwasm/swift/issues/1887">the lack of
standardized multi-threading support</a> in WebAssembly
and SwiftWasm itself. Many Foundation APIs rely on the presence of Dispatch under the hood,
specifically threading helpers. A few other types are unavailable in browsers
or aren‚Äôt standardized in WASI hosts, such as support for sockets and low-level networking,
and they had to be disabled. These types are therefore absent in SwiftWasm Foundation:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Type or module</th><th>Status</th></tr>
</thead>
<tbody>
<tr><td><code>FoundationNetworking</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>FileManager</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>Host</code></td><td>‚úÖ Partially available after 6.0</td></tr>
<tr><td><code>Notification</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>NotificationQueue</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>NSKeyedArchiver</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>NSKeyedArchiverHelpers</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>NSKeyedCoderOldStyleArray</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>NSKeyedUnarchiver</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>NSNotification</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>NSSpecialValue</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>Port</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>PortMessage</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>Process</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>ProcessInfo</code></td><td>‚úÖ Partially available after 5.7</td></tr>
<tr><td><code>PropertyListEncoder</code></td><td>‚úÖ Available after 6.0</td></tr>
<tr><td><code>RunLoop</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>Stream</code></td><td>‚úÖ Partially available after 6.0</td></tr>
<tr><td><code>SocketPort</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>Thread</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>Timer</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>UserDefaults</code></td><td>‚úÖ Available after 6.0</td></tr>
</tbody>
</table>
</div>
<p>Related functions and properties on other types are also absent or disabled. We would like to make
them available in the future as soon as possible, and <a href="#contribution-guide">we invite you to
contribute</a> and help us in achieving this goal!</p>
<h2 id="xctest"><a class="header" href="#xctest">XCTest</a></h2>
<p><a href="https://github.com/swiftlang/swift-corelibs-xctest">The swift-corelibs-xctest project</a> is available
in WebAssembly platforms, and you can use it to write tests for your SwiftWasm projects.</p>
<p>The following XCTest features are unavailable in SwiftWasm:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>API</th><th>Status</th></tr>
</thead>
<tbody>
<tr><td><code>XCTestExpectation</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>XCTNSPredicateExpectation</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>XCTNSNotificationExpectation</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>XCTWaiter</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>XCTest.perform</code></td><td>‚ùå Unavailable</td></tr>
<tr><td><code>XCTest.run</code></td><td>‚ùå Unavailable</td></tr>
</tbody>
</table>
</div>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="creating-a-browser-app"><a class="header" href="#creating-a-browser-app">Creating a Browser App</a></h1>
<blockquote>
<p>This page has now been replaced by the <a href="https://swiftpackageindex.com/swiftwasm/javascriptkit/tutorials/javascriptkit/hello-world">JavaScriptKit‚Äôs tutorial</a>.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="javascript-interoperation"><a class="header" href="#javascript-interoperation">JavaScript interoperation</a></h1>
<p><a href="https://github.com/swiftwasm/JavaScriptKit">JavaScriptKit</a> is a Swift framework to interact with JavaScript through WebAssembly.</p>
<p>You can use any JavaScript API from Swift with this library. Here‚Äôs a quick example of JavaScriptKit
usage in a browser app:</p>
<pre><code class="language-swift">import JavaScriptKit

let document = JSObject.global.document

var divElement = document.createElement("div")
divElement.innerText = "Hello, world"
_ = document.body.appendChild(divElement)
</code></pre>
<p>You can also use JavaScriptKit in SwiftWasm apps integrated with Node.js, as there no assumptions
that any browser API is present in the library.</p>
<p>JavaScriptKit consists of a runtime library package <a href="https://www.npmjs.com/package/javascript-kit-swift">hosted on
npm</a>, and a SwiftPM package for the API on the
Swift side. To integrate the JavaScript runtime automatically into your app, we recommend following
the corresponding <a href="#creating-a-browser-app">guide for browser apps in our book</a>.</p>
<p>You can get more detailed JavaScriptKit documentation <a href="https://swiftwasm.github.io/JavaScriptKit/">here</a>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="running-async-functions-in-webassembly"><a class="header" href="#running-async-functions-in-webassembly">Running <code>async</code> functions in WebAssembly</a></h1>
<p>On macOS, iOS, and Linux, <code>libdispatch</code>-based executor is used by default, but <code>libdispatch</code> is not supported in single-threaded WebAssembly environment.
However, there are still two global task executors available in SwiftWasm.</p>
<p>If you need multi-threading support on Web, please see <a href="#using-threads-in-webassembly">Multithreading guide</a> for more details.</p>
<h2 id="cooperative-task-executor"><a class="header" href="#cooperative-task-executor">Cooperative Task Executor</a></h2>
<p><code>Cooperative Task Executor</code> is the default task executor in SwiftWasm. It is a simple single-threaded cooperative task executor implemented in <a href="https://github.com/apple/swift/blob/0c67ce64874d83b2d4f8d73b899ee58f2a75527f/stdlib/public/Concurrency/CooperativeGlobalExecutor.inc">Swift Concurrency library</a>.
If you are not familiar with ‚ÄúCooperative‚Äù in concurrent programming term, see <a href="https://en.wikipedia.org/wiki/Cooperative_multitasking">its definition for more details</a>.</p>
<p>This executor has an <em>event loop</em> that dispatches tasks until no more tasks are enqueued, and exits immediately after all tasks are dispatched.
Note that this executor won‚Äôt yield control to the host environment during execution, so any host‚Äôs async operation cannot call back to the Wasm execution.</p>
<p>This executor is suitable for WASI command line tools, or host-independent standalone applications.</p>
<pre><code class="language-swift">// USAGE
// $ swiftc -target wasm32-unknown-wasi -parse-as-library main.swift -o main.wasm
// $ wasmtime main.wasm
@main
struct Main {
    static func main() async throws {
        print("Sleeping for 1 second... üò¥")
        try await Task.sleep(nanoseconds: 1_000_000_000)
        print("Wake up! üòÅ")
    }
}
</code></pre>
<h2 id="javascript-event-loop-based-task-executor"><a class="header" href="#javascript-event-loop-based-task-executor">JavaScript Event Loop-based Task Executor</a></h2>
<p><code>JavaScript Event Loop-based Task Executor</code> is a task executor that cooperates with the JavaScript‚Äôs event loop. It is provided by <a href="https://github.com/swiftwasm/JavaScriptKit"><code>JavaScriptKit</code></a>, and you need to activate it explicitly by calling a predefined <code>JavaScriptEventLoop.installGlobalExecutor()</code> function (see below for more details).</p>
<p>This executor also has its own <em>event loop</em> that dispatches tasks until no more tasks are enqueued synchronously.
It yields control to the JavaScript side after all pending tasks are dispatched, so JavaScript program can call back to the executed Wasm module.
After a task is resumed by callbacks from JavaScript, the executor starts its event loop again in the next microtask tick.</p>
<p>To enable this executor, you need to use <code>JavaScriptEventLoop</code> module, which is provided as a part of <code>JavaScriptKit</code> package.</p>
<ol start="0">
<li>Ensure that you added <code>JavaScriptKit</code> dependency to your <code>Package.swift</code></li>
<li>Add <code>JavaScriptEventLoop</code> dependency to your targets that use this executor</li>
</ol>
<pre><code class="language-swift">.product(name: "JavaScriptEventLoop", package: "JavaScriptKit"),
</code></pre>
<ol start="2">
<li>Import <code>JavaScriptEventLoop</code> and call <code>JavaScriptEventLoop.installGlobalExecutor()</code> before spawning any tasks to activate the executor instead of the default cooperative executor.</li>
</ol>
<p>Note that this executor is only available on JavaScript host environment.</p>
<p>See also <a href="https://github.com/swiftwasm/JavaScriptKit/#asyncawait"><code>JavaScriptKit</code> package <code>README</code></a> for more details.</p>
<pre><code class="language-swift">import JavaScriptEventLoop
import JavaScriptKit

JavaScriptEventLoop.installGlobalExecutor()

let document = JSObject.global.document
var asyncButtonElement = document.createElement("button")
_ = document.body.appendChild(asyncButtonElement)

asyncButtonElement.innerText = "Fetch Zen"
func printZen() async throws {
    let fetch = JSObject.global.fetch.function!
    let response = try await JSPromise(fetch("https://api.github.com/zen").object!)!.value
    let text = try await JSPromise(response.text().object!)!.value
    print(text)
}
asyncButtonElement.onclick = .object(JSClosure { _ in
    Task {
        do {
            try await printZen()
        } catch {
            print(error)
        }
    }

    return .undefined
})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="using-threads-in-webassembly"><a class="header" href="#using-threads-in-webassembly">Using threads in WebAssembly</a></h1>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>While the WebAssembly spec defines <a href="https://github.com/WebAssembly/threads">atomic operations</a>,
it does not define a way to create threads. This means that WebAssembly modules can‚Äôt create
threads themselves, and the host environment must provide a way to create threads and run
WebAssembly modules on them.</p>
<h2 id="wasi-threads-proposal"><a class="header" href="#wasi-threads-proposal"><a href="https://github.com/WebAssembly/wasi-threads"><code>wasi-threads</code></a> proposal</a></h2>
<p>The WebAssembly System Interface (WASI) had a proposal for adding thread creation APIs to WASI.
The proposal was implemented in several WASI host runtimes, including Wasmtime and wasm-micro-runtime,
but it was <a href="https://github.com/WebAssembly/wasi-threads/issues/48#issuecomment-1696407630">withdrawn in August 2023</a> in favor of <a href="https://github.com/WebAssembly/shared-everything-threads">shared-everything-threads</a> proposal. However, the shared-everything-threads proposal is still in the early stages of development and is not yet available in any WASI host runtime. So, for now, we are employing the <code>wasi-threads</code> ABI in SwiftWasm to provide thread support immediately.</p>
<p>The <code>wasi-threads</code> feature is only available in the <code>wasm32-unknown-wasip1-threads</code> target triple, which is explicitly distinct from the <code>wasm32-unknown-wasi</code> target triple.</p>
<p>The <code>wasm32-unknown-wasip1-threads</code> target triple is only available in the nightly Swift SDK for WebAssembly.</p>
<p>You can run WebAssembly programs built with the <code>wasm32-unknown-wasip1-threads</code> target by using the <code>wasmtime</code> runtime with the <code>--wasi threads</code> flag.
Check <a href="https://github.com/swiftwasm/swift/releases">a recent nightly Swift SDK release</a> and how to install it <a href="getting-started/setup-snapshot.html">here</a>.</p>
<pre><code class="language-console"># Assume you are using swift-DEVELOPMENT-SNAPSHOT-2024-12-04-a toolchain
$ swift sdk install https://github.com/swiftwasm/swift/releases/download/swift-wasm-DEVELOPMENT-SNAPSHOT-2024-12-05-a/swift-wasm-DEVELOPMENT-SNAPSHOT-2024-12-05-a-wasm32-unknown-wasip1-threads.artifactbundle.zip --checksum 1796ae86f3c90b45d06ee29bb124577aa4135585bbd922430b6d1786f855697d
$ swift build --swift-sdk wasm32-unknown-wasip1-threads
# Enable the `wasi-threads` feature in wasmtime
$ wasmtime --wasi threads .build/debug/Example.wasm
</code></pre>
<p>Note that even with the <code>wasi-threads</code> feature, the default concurrency execution model is still single-threaded as we have not yet ported libdispatch. The <code>wasi-threads</code> feature is only used to provide a low-level <code>pthread</code> API for creating threads.</p>
<h2 id="webworkertaskexecutor---shared-everything-concurrency"><a class="header" href="#webworkertaskexecutor---shared-everything-concurrency"><code>WebWorkerTaskExecutor</code> - shared-everything concurrency</a></h2>
<p>We provide <code>WebWorkerTaskExecutor</code>, a <a href="https://github.com/swiftlang/swift-evolution/blob/main/proposals/0417-task-executor-preference.md"><code>TaskExecutor</code></a> implementation that runs <code>Task</code>s in a Web Worker. This allows you to run Swift code concurrently in a Web Worker sharing the same memory space.</p>
<p>This feature is available in the <code>JavaScriptKit</code> package and you need to use <code>wasm32-unkonwn-wasip1-threads</code> target and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer"><code>SharedArrayBuffer</code></a> to use it.</p>
<p>See more details in the following links:</p>
<ul>
<li><a href="https://github.com/swiftwasm/JavaScriptKit/pull/256">Add <code>WebWorkerTaskExecutor</code> ¬∑ Pull Request #256 ¬∑ swiftwasm/JavaScriptKit</a></li>
<li><a href="https://github.com/swiftwasm/JavaScriptKit/tree/main/Examples/Multithreading">JavaScriptKit/Examples/Multithreading at main ¬∑ swiftwasm/JavaScriptKit</a></li>
<li><a href="https://swiftpackageindex.com/swiftwasm/javascriptkit/main/documentation/javascripteventloop/webworkertaskexecutor">WebWorkerTaskExecutor | Documentation</a></li>
</ul>
<h2 id="webworkerkit---shared-nothing-concurrency"><a class="header" href="#webworkerkit---shared-nothing-concurrency"><code>WebWorkerKit</code> - shared-nothing concurrency</a></h2>
<p>If you can‚Äôt use <code>SharedArrayBuffer</code> or want to run Swift code in a separate memory space, you can use <code>WebWorkerKit</code>. <code>WebWorkerKit</code> is a library that provides a way to run Swift Distributed Actors in their own worker ‚Äúthread‚Äù in a Web Worker. It‚Äôs message-passing based and allows you to run Swift code concurrently in a Web Worker without sharing memory space.</p>
<p>Check the repository for more details: <a href="https://github.com/swiftwasm/WebWorkerKit">swiftwasm/WebWorkerKit: A way of running Swift Distributed Actors in their own worker ‚Äúthread‚Äù</a></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="testing-your-app"><a class="header" href="#testing-your-app">Testing your app</a></h1>
<p>You can write a test suite for your SwiftWasm app or library, or run an existing test suite
written for <code>XCTest</code> if you port existing code to SwiftWasm. Your project has to have a
<code>Package.swift</code> package manifest for this to work. We assume that you use SwiftPM to build your
project and that you have a working package manifest. Please follow <a href="getting-started/swift-package.html">our SwiftPM guide</a> for new projects.</p>
<h2 id="a-simple-test-case"><a class="header" href="#a-simple-test-case">A simple test case</a></h2>
<p>Let‚Äôs assume you have an <code>Example</code> target in your project that you‚Äôd like to test. Your
<code>Package.swift</code> should also have a test suite target with a dependency on the library target. It
would probably look like this:</p>
<pre><code class="language-swift">// swift-tools-version: 5.9

import PackageDescription

let package = Package(
    name: "Example",
    products: [
        .library(name: "Example", targets: ["Example"]),
    ],
    targets: [
        .target(name: "Example"),
        .testTarget(name: "ExampleTests", dependencies: ["Example"]),
    ]
)
</code></pre>
<p>Now you should make sure there‚Äôs <code>Tests/ExampleTests</code> subdirectory in your project.
If you don‚Äôt have any files in it yet, create <code>ExampleTests.swift</code> in it:</p>
<pre><code class="language-swift">import Example
import XCTest

final class ExampleTests: XCTestCase {
  func testTrivial() {
    XCTAssertEqual(text, "Hello, world")
  }
}
</code></pre>
<p>This code assumes that your <code>Example</code> defines some <code>text</code> with <code>"Hello, world"</code> value
for this test to pass. Your test functions should all start with <code>test</code>, please see <a href="https://developer.apple.com/documentation/xctest/defining_test_cases_and_test_methods">XCTest
documentation</a>
for more details.</p>
<h2 id="building-and-running-the-test-suite-with-swiftpm"><a class="header" href="#building-and-running-the-test-suite-with-swiftpm">Building and running the test suite with <code>SwiftPM</code></a></h2>
<p>You can build your test suite by running this command in your terminal:</p>
<pre><code class="language-sh">$ swift build --build-tests --triple wasm32-unknown-wasi
</code></pre>
<p>If you‚Äôre used to running <code>swift test</code> to run test suites for other Swift platforms, we have to
warn you that this won‚Äôt work. <code>swift test</code> doesn‚Äôt know what WebAssembly environment you‚Äôd like to
use to run your tests. Because of this building tests and running them are two separate steps when
using <code>SwiftPM</code>. After your tests are built, you can use a WASI-compatible host such as
<a href="https://wasmtime.dev/">wasmtime</a> to run the test bundle:</p>
<pre><code class="language-sh">$ wasmtime --dir . .build/wasm32-unknown-wasi/debug/ExamplePackageTests.wasm
</code></pre>
<p>(<code>--dir .</code> is used to allow XCTest to find <code>Bundle.main</code> resources placed alongside the executable file.)</p>
<p>As you can see, the produced test binary starts with the name of your package followed by
<code>PackageTests.wasm</code>. It is located in the <code>.build/debug</code> subdirectory, or in the <code>.build/release</code>
subdirectory when you build in release mode.</p>
<h2 id="code-coverage-with-swiftpm"><a class="header" href="#code-coverage-with-swiftpm">Code coverage with <code>SwiftPM</code></a></h2>
<blockquote>
<p><strong>Note</strong>: Code coverage support is available only in 6.1 and later.</p>
</blockquote>
<p>You can also generate code coverage reports for your test suite. To do this, you need to build your
test suite with the <code>--enable-code-coverage</code> and linker options <code>-Xlinker -lwasi-emulated-getpid</code>:</p>
<pre><code class="language-sh">$ swift build --build-tests --swift-sdk wasm32-unknown-wasi --enable-code-coverage -Xlinker -lwasi-emulated-getpid
</code></pre>
<p>After building your test suite, you can run it with <code>wasmtime</code> as described above. The raw coverage
data will be stored in <code>default.profraw</code> file in the current directory. You can use the <code>llvm-profdata</code>
and <code>llvm-cov</code> tools to generate a human-readable report:</p>
<pre><code class="language-sh">$ wasmtime --dir . .build/wasm32-unknown-wasi/debug/ExamplePackageTests.wasm
$ llvm-profdata merge default.profraw -o default.profdata
$ llvm-cov show .build/wasm32-unknown-wasi/debug/ExamplePackageTests.wasm -instr-profile=default.profdata
# or generate an HTML report
$ llvm-cov show .build/wasm32-unknown-wasi/debug/ExamplePackageTests.wasm -instr-profile=default.profdata --format=html -o coverage
$ open coverage/index.html
</code></pre>
<p><img src="getting-started/coverage-support.png" alt=""></p>
<h2 id="building-and-running-the-test-suite-with-carton"><a class="header" href="#building-and-running-the-test-suite-with-carton">Building and running the test suite with <code>carton</code></a></h2>
<p>If you use <a href="https://carton.dev"><code>carton</code></a> to develop and build your app, as described in <a href="#creating-a-browser-app">our guide
for browser apps</a>, just run <code>swift run carton test</code> in the
root directory of your package. This will automatically build the test suite and run it with a WASI runtime for you.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="configuring-visual-studio-code-with-webassembly-sdk"><a class="header" href="#configuring-visual-studio-code-with-webassembly-sdk">Configuring Visual Studio Code with WebAssembly SDK</a></h1>
<p>This guide will help you configure Visual Studio Code (VSCode) to use the Swift SDK for WebAssembly.</p>
<blockquote>
<p><strong>Note</strong>: This guide assumes you have already installed the <a href="getting-started/setup-snapshot.html">Swift SDK for WebAssembly</a> from the development snapshot release.</p>
</blockquote>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ul>
<li><a href="https://code.visualstudio.com/">Visual Studio Code</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=sswg.swift-lang">Swift for Visual Studio Code</a></li>
<li><a href="https://swift.org/install">Swift OSS Toolchain</a> (6.1 or later)</li>
<li><a href="getting-started/setup-snapshot.html">Swift SDK for WebAssembly</a></li>
</ul>
<h2 id="configure-your-swiftpm-package"><a class="header" href="#configure-your-swiftpm-package">Configure your SwiftPM package</a></h2>
<ol>
<li>Open your Swift package in VSCode.</li>
<li>Create a <code>.vscode/settings.json</code> with the following content:</li>
</ol>
<pre><code class="language-json">{
    "swift.path": "&lt;path-to-swift-toolchain-from-swift.org&gt;/usr/bin",
}
</code></pre>
<blockquote>
<p><strong>Note</strong>: Replace <code>&lt;path-to-swift-toolchain-from-swift.org&gt;</code> with the path to the development snapshot Swift toolchain you downloaded from <a href="https://www.swift.org/install">swift.org/install</a>.</p>
</blockquote>
<ol start="3">
<li>Create a <code>.sourcekit-lsp/config.json</code> with the following content:</li>
</ol>
<pre><code class="language-json">{
    "swiftPM": {
        "swiftSDK": "&lt;Swift SDK id&gt;"
    }
}
</code></pre>
<blockquote>
<p><strong>Note</strong>: Replace <code>&lt;Swift SDK id&gt;</code> with the Swift SDK id you installed using the <code>swift sdk install</code> command. You can find the installed SDK id by running <code>swift sdk list</code>.</p>
</blockquote>
<ol start="4">
<li>Reload the VSCode window by pressing <code>Cmd + Shift + P</code> and selecting <code>Reload Window</code>.</li>
</ol>
<p>That‚Äôs it! You can now build and auto-complete your Swift package using the Swift SDK for WebAssembly.</p>
<p><img src="getting-started/vscode-editing.png" alt=""></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="debugging"><a class="header" href="#debugging">Debugging</a></h1>
<p>Debugging is one of the most important parts of application development. This section describes debugging tools compatible with SwiftWasm.</p>
<p>These tools are DWARF-based, so you need to build your application with DWARF sections enabled.
If you are using <code>carton bundle</code>, you can use the <code>--debug-info</code> flag to enable debugging with optimized application.
If you are using <code>swift build</code>, it is enabled by default.</p>
<h2 id="chrome-devtools"><a class="header" href="#chrome-devtools">Chrome DevTools</a></h2>
<p>When you are debugging a web browser application, Chrome DevTools is a good tool to use. It allows you to
put breakpoints and step through at Swift source code level.</p>
<h3 id="official-dwarf-extension"><a class="header" href="#official-dwarf-extension">Official DWARF Extension</a></h3>
<p>Install <a href="https://goo.gle/wasm-debugging-extension"><code>C/C++ DevTools Support (DWARF)</code></a> extension in your Chrome</p>
<p>See <a href="https://developer.chrome.com/blog/wasm-debugging-2020">the DevTools team‚Äôs official introduction</a> for more details about the extension.</p>
<p><img src="getting-started/chrome-devtools.png" alt=""></p>
<p>Note that the function names in the stack trace are mangled. You can demangle them using <code>swift demangle</code> command.</p>
<p>Unfortunately, variable inspection is unavailable since Swift depends on its own mechanisms to do that instead of DWARF‚Äôs structure type feature. If you need this feature, you can use the enhanced extension below.</p>
<h3 id="enhanced-dwarf-extension-for-swift"><a class="header" href="#enhanced-dwarf-extension-for-swift">Enhanced DWARF Extension for Swift</a></h3>
<p>For a better Swift debugging experience, there‚Äôs also an enhanced version of the DWARF extension specifically for Swift. This extension enables:</p>
<ul>
<li>Breakpoint setting and Swift code inspection</li>
<li>Human-readable call stack frames</li>
<li>Swift variable value inspection</li>
</ul>
<p>To install this enhanced extension:</p>
<ol>
<li>First, uninstall the official ‚ÄúC/C++ DevTools Support (DWARF)‚Äù extension if you have it installed</li>
<li>Download the extension ZIP file from <a href="https://github.com/GoodNotes/devtools-frontend/releases/tag/swift-0.2.3.0">GitHub Releases</a></li>
<li>Go to <code>chrome://extensions/</code> and enable ‚ÄúDeveloper mode‚Äù</li>
<li>Drag and drop the downloaded ZIP file into the page</li>
</ol>
<p>When you close and reopen the DevTools window, DevTools will suggest reloading itself to apply settings.</p>
<p>Note: There is a known issue where some JavaScriptKit types like <code>JSObject</code> and <code>JSValue</code> are not shown in pretty format in the variables view.</p>
<p><img src="getting-started/chrome-devtools-swift.png" alt=""></p>
<h2 id="wasminspect"><a class="header" href="#wasminspect"><a href="https://github.com/kateinoigakukun/wasminspect">wasminspect</a></a></h2>
<p><a href="https://github.com/kateinoigakukun/wasminspect">wasminspect</a>
can help in the investigation if the debugged binary does not rely on integration with JavaScript.
We recommend splitting your packages into separate executable targets, most of which shouldn‚Äôt
assume the availability of JavaScript to make debugging easier.</p>
<p><img src="https://raw.githubusercontent.com/kateinoigakukun/wasminspect/master/assets/demo.gif" alt="demo"></p>
<h2 id="wasm-memprof"><a class="header" href="#wasm-memprof"><a href="https://github.com/kateinoigakukun/wasm-memprof">wasm-memprof</a></a></h2>
<p>If you are debugging memory leaks, <a href="https://github.com/kateinoigakukun/wasm-memprof">wasm-memprof</a> can help you.
It is a tool to profile memory usage of WebAssembly applications with a few lines of setup code:</p>
<pre><code class="language-javascript">import { WMProf } from "wasm-memprof";
import { SwiftDemangler } from "wasm-memprof/plugins/swift-demangler.js";

const swiftDemangler = SwiftDemangler.create();
const WebAssembly = WMProf.wrap(globalThis.WebAssembly, {
  demangler: swiftDemangler.demangle.bind(swiftDemangler),
});
</code></pre>
<p>Check the repository for more details.</p>
<img width="1000" alt="swift-wmprof" src="https://github.com/user-attachments/assets/c1da4582-e721-45b9-9bca-ce320711f72d">
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h1>
<p>These are some common issues you may run into while using SwiftWasm.</p>
<p>If you are having trouble that is not listed here, try searching for it in the <a href="https://github.com/swiftwasm/swift/issues">SwiftWasm issue tracker</a>.
If you are still having trouble, please file an issue or contact us at <a href="https://discord.gg/ashJW8T8yp">the community Discord server</a>.</p>
<h2 id="runtimeerror-memory-access-out-of-bounds"><a class="header" href="#runtimeerror-memory-access-out-of-bounds"><code>RuntimeError: memory access out of bounds</code></a></h2>
<p>If you encounter this error, there are 3 possible causes:</p>
<h3 id="1-you-are-trying-to-access-invalid-memory-in-your-code"><a class="header" href="#1-you-are-trying-to-access-invalid-memory-in-your-code">1. You are trying to access invalid memory in your code</a></h3>
<p>In this case, you need to make sure which memory operations are invalid in your code by <code>UnsafePointer</code> or C code.</p>
<h3 id="2-you-missed-program-initialization-defined-in-wasi-application-abi"><a class="header" href="#2-you-missed-program-initialization-defined-in-wasi-application-abi">2. You missed program initialization defined in <a href="https://github.com/WebAssembly/WASI/blob/bac366c8aeb69cacfea6c4c04a503191bf1cede1/legacy/application-abi.md">WASI Application ABI</a>.</a></h3>
<p>If your application is used as a library, you need to follow <a href="https://github.com/WebAssembly/WASI/blob/bac366c8aeb69cacfea6c4c04a503191bf1cede1/legacy/application-abi.md"><em>WASI reactor ABI</em></a>.</p>
<p>Please make sure that you followed it by reviewing the <a href="#exporting-function-for-host-environment">Exporting function guide</a></p>
<h3 id="3-stack-overflow-is-occurring"><a class="header" href="#3-stack-overflow-is-occurring">3. Stack overflow is occurring.</a></h3>
<p>If you are using <code>--stack-first</code> linker option (carton uses it by default), you can face <code>RuntimeError: memory access out of bounds</code> error due to stack overflow.</p>
<p>You have two options to solve this issue:</p>
<ol>
<li>
<p>Avoid recursive calls if possible.</p>
</li>
<li>
<p>Extend the stack size by linker option <code>-z stack-size=&lt;size&gt;</code>. <a href="https://github.com/llvm/llvm-project/blob/fabe915705472e2c06ed1aa9a90620462594e82f/llvm/include/llvm/BinaryFormat/Wasm.h#L32">The default stack size is 64KB</a></p>
<pre><code>swift build --triple wasm32-unknown-wasi -Xlinker -z -Xlinker stack-size=131072
</code></pre>
</li>
<li>
<p>Identify which function consumes a lof of stack space by some tools like <a href="https://github.com/kateinoigakukun/wasm-stack-consumer">wasm-stack-consumer</a></p>
</li>
</ol>
<p>See also: <a href="https://bugs.llvm.org/show_bug.cgi?id=37181">LLVM Bugzilla ‚Äì wasm32: Allow placing the stack before global data</a></p>
<h2 id="fatal-error-stdlibh-file-not-found"><a class="header" href="#fatal-error-stdlibh-file-not-found"><code>fatal error: 'stdlib.h' file not found</code></a></h2>
<p>If you encounter this error, please make sure that:</p>
<ul>
<li>You are using SwiftWasm toolchain (if you installed it as a toolchain, not as a Swift SDK)
<ul>
<li>Check <code>which swift</code> and make sure it points to the SwiftWasm toolchain.</li>
</ul>
</li>
<li>You are using the correct target triple:
<ul>
<li><code>--triple wasm32-unknown-wasi --static-swift-stdlib</code> if you installed as a <em>toolchain</em></li>
<li><code>--swift-sdk wasm32-unknown-wasi</code> if you installed as a <em>Swift SDK</em></li>
</ul>
</li>
</ul>
<h2 id="error-missing-external-dependency-usrlibswiftwasistatic-executable-argslnk"><a class="header" href="#error-missing-external-dependency-usrlibswiftwasistatic-executable-argslnk"><code>error: missing external dependency '.../usr/lib/swift/wasi/static-executable-args.lnk'</code></a></h2>
<p>You may encounter this error while building with Swift SDK for WebAssembly and <code>swiftc</code> driver command. Unfortunately, Swift SDK does not support building with <code>swiftc</code> command yet, so you need to use <code>swift build</code> Swift Package Manager command instead.</p>
<p>e.g. <code>swift build --swift-sdk &lt;SDK name&gt;</code></p>
<p>See also: <a href="getting-started/swift-package.html">Compile a SwiftPM package to WebAssembly</a></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<p>This section shows you example usage of our toolchain.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="importing-a-function-from-host-environments"><a class="header" href="#importing-a-function-from-host-environments">Importing a function from host environments</a></h1>
<h2 id="swift-60-or-later"><a class="header" href="#swift-60-or-later">Swift 6.0 or later</a></h2>
<p>If you are using Swift 6.0 or later, you can use experimental <code>@_extern(wasm)</code> attribute</p>
<p>Swift 6.0 introduces a new attribute <code>@_extern(wasm)</code> to import a function from the host environment.
To use this experimental feature, you need to enable it in your SwiftPM manifest file:</p>
<pre><code class="language-swift">.executableTarget(
    name: "Example",
    swiftSettings: [
        .enableExperimentalFeature("Extern")
    ]),
</code></pre>
<p>Then, you can import a function from the host environment as follows without using C headers:</p>
<pre><code class="language-swift">@_extern(wasm, module: "env", name: "add")
func add(_ a: Int, _ b: Int) -&gt; Int

print(add(2, 2))
</code></pre>
<h2 id="swift-510-or-earlier"><a class="header" href="#swift-510-or-earlier">Swift 5.10 or earlier</a></h2>
<p>You can import a function from your host environment using the integration of Swift Package Manager
with C targets. Firstly, you should declare a signature for your function in a C header with an
appropriate <code>__import_name__</code> attribute:</p>
<pre><code class="language-c">__attribute__((__import_name__("add")))
extern int add(int lhs, int rhs);
</code></pre>
<p>Here <code>__import_name__</code> specifies the name under which this function will be exposed to Swift code.
Move this C header to a separate target, we‚Äôll call it <code>HostFunction</code> in this example. Your
<code>Package.swift</code> manifest for your WebAssembly app would look like this:</p>
<pre><code class="language-swift">// swift-tools-version:5.9
import PackageDescription

let package = Package(
    name: "Example",
    targets: [
      .target(name: "HostFunction", dependencies: []),
      .executableTarget(name: "Example", dependencies: ["HostFunction"]),
    ]
)
</code></pre>
<p>Place this header into the <code>include</code> subdirectory of your <code>HostFunction</code> target directory. You can
then import this host function module into Swift code just as any other module:</p>
<pre><code class="language-swift">import HostFunction

print(add(2, 2))
</code></pre>
<p>Then, you can inject a host function into the produced WebAssembly binary.</p>
<p>Note that we use <code>env</code> as default import module name. You can specify the module name as
<code>__import_module__</code> in your C header. The full list of attributes in the header could look
like <code>__attribute__((__import_module__("env"),__import_name__("add")))</code>.</p>
<pre><code class="language-javascript">// File name: main.mjs
import { WASI, File, OpenFile, ConsoleStdout } from "@bjorn3/browser_wasi_shim";
import fs from "fs/promises";

const main = async () =&gt; {

  // Instantiate a new WASI Instance
  // See https://github.com/bjorn3/browser_wasi_shim/ for more detail about constructor options
  let wasi = new WASI([], [],
    [
      new OpenFile(new File([])), // stdin
      ConsoleStdout.lineBuffered(msg =&gt; console.log(`[WASI stdout] ${msg}`)),
      ConsoleStdout.lineBuffered(msg =&gt; console.warn(`[WASI stderr] ${msg}`)),
    ],
    { debug: false }
  );

  const wasmBinary = await fs.readFile(".build/wasm32-unknown-wasi/debug/Example.wasm");

  // Instantiate the WebAssembly file
  let { instance } = await WebAssembly.instantiate(wasmBinary, {
    wasi_snapshot_preview1: wasi.wasiImport,
    env: {
      add: (lhs, rhs) =&gt; (lhs + rhs),
    }
  });

  wasi.start(instance);
};

main()
</code></pre>
<p>If you use Go bindings for Wasmer as your host environment, you should check <a href="https://github.com/hassan-shahbazi/swiftwasm-go">an example
repository</a> from one of our contributors that shows
an integration with an imported host function.</p>
<p>A more streamlined way to import host functions will be implemented in the future version of the
SwiftWasm toolchain.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="exporting-function-for-host-environment"><a class="header" href="#exporting-function-for-host-environment">Exporting function for host environment</a></h1>
<h2 id="swift-60-or-later-1"><a class="header" href="#swift-60-or-later-1">Swift 6.0 or later</a></h2>
<p>If you use Swift 6.0 or later, you can use <code>@_expose(wasm, "add")</code> and omit the <code>--export</code> linker flag.</p>
<pre><code class="language-swift">// File name: lib.swift
@_expose(wasm, "add")
@_cdecl("add") // This is still required to call the function with C ABI
func add(_ lhs: Int, _ rhs: Int) -&gt; Int {
    return lhs + rhs
}
</code></pre>
<p>Then you can compile the Swift code with the following command without <code>--export</code> linker flag.</p>
<pre><code class="language-bash">$ swiftc \
    -target wasm32-unknown-wasi \
    -parse-as-library \
    lib.swift -o lib.wasm \
    -Xclang-linker -mexec-model=reactor
</code></pre>
<h2 id="swift-510-or-earlier-1"><a class="header" href="#swift-510-or-earlier-1">Swift 5.10 or earlier</a></h2>
<p>You can expose a Swift function for host environment using special attribute and linker option.</p>
<pre><code class="language-swift">// File name: lib.swift
@_cdecl("add")
func add(_ lhs: Int, _ rhs: Int) -&gt; Int {
    return lhs + rhs
}
</code></pre>
<p>You need to compile the Swift code with linker option <code>--export</code>.</p>
<p>To call the exported function as a library multiple times, you need to:</p>
<ol>
<li>Compile it as a <a href="https://github.com/WebAssembly/WASI/blob/bac366c8aeb69cacfea6c4c04a503191bf1cede1/legacy/application-abi.md"><em>WASI reactor</em> execution model</a>.
The default execution model is <em>command</em>, so you need to pass <code>-mexec-model=reactor</code> to linker.</li>
<li>Call <code>_initialize</code> function before interacting with the instance.</li>
</ol>
<pre><code class="language-bash">$ swiftc \
    -target wasm32-unknown-wasi \
    -parse-as-library \
    lib.swift -o lib.wasm \
    -Xlinker --export=add \
    -Xclang-linker -mexec-model=reactor
</code></pre>
<p>Then, you can use the exported function from host environment.</p>
<pre><code class="language-javascript">// File name: main.mjs
import { WASI, File, OpenFile, ConsoleStdout } from "@bjorn3/browser_wasi_shim";
import fs from "fs/promises";

// Instantiate a new WASI Instance
// See https://github.com/bjorn3/browser_wasi_shim/ for more detail about constructor options
let wasi = new WASI([], [],
  [
    new OpenFile(new File([])), // stdin
    ConsoleStdout.lineBuffered(msg =&gt; console.log(`[WASI stdout] ${msg}`)),
    ConsoleStdout.lineBuffered(msg =&gt; console.warn(`[WASI stderr] ${msg}`)),
  ],
  { debug: false }
);

const wasmBinary = await fs.readFile("lib.wasm");

// Instantiate the WebAssembly file
const { instance } = await WebAssembly.instantiate(wasmBinary, {
  wasi_snapshot_preview1: wasi.wasiImport,
});
// Initialize the instance by following WASI reactor ABI
wasi.initialize(instance);
// Get the exported function
const addFn = instance.exports.add;
console.log("2 + 3 = " + addFn(2, 3))
</code></pre>
<p>If you use SwiftPM package, you can omit linker flag using clang‚Äôs <code>__atribute__</code>. Please see <a href="https://github.com/swiftwasm/JavaScriptKit/pull/91/files">swiftwasm/JavaScriptKit#91</a> for more detail info</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="example-projects-1"><a href="#example-projects-1" class="header">Example projects</a></h1>
<h2 id="example-projects"><a class="header" href="#example-projects">Example Projects</a></h2>
<p>You can learn more practical usage of our toolchain in <a href="https://github.com/swiftwasm/awesome-swiftwasm">swiftwasm/awesome-swiftwasm</a></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="contribution-guide"><a class="header" href="#contribution-guide">Contribution Guide</a></h1>
<h2 id="repositories"><a class="header" href="#repositories">Repositories</a></h2>
<h3 id="swiftwasmswiftwasm-build"><a class="header" href="#swiftwasmswiftwasm-build"><a href="https://github.com/swiftwasm/swiftwasm-build">swiftwasm/swiftwasm-build</a></a></h3>
<p>The main development repository for the SwiftWasm project. It contains the build script and patches for building the Swift compiler and standard library for WebAssembly. See the <a href="https://github.com/swiftwasm/swiftwasm-build/blob/main/README.md">README</a> for more information.</p>
<h3 id="swiftwasmicu4c-wasi"><a class="header" href="#swiftwasmicu4c-wasi"><a href="https://github.com/swiftwasm/icu4c-wasi">swiftwasm/icu4c-wasi</a></a></h3>
<p>Build script and patches for building ICU project for WebAssembly. <a href="https://github.com/unicode-org/icu/pull/990">The required changes to build
it</a> were merged to the upstream repository.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="how-to-build-toolchain"><a class="header" href="#how-to-build-toolchain">How to build toolchain</a></h1>
<p>This document describes how to build the toolchain for WebAssembly.
This is just a quick guide, so if you want to know more about the toolchain, it might be good entry point to read <a href="https://github.com/swiftwasm/swiftwasm-build/blob/main/.github/workflows/build-toolchain.yml">continuous integration scripts</a>.
Or you can ask questions in GitHub issues or SwiftWasm Discord server (see <a href="https://swiftwasm.org">the official website</a> for the link).</p>
<h2 id="1-checkout-the-project-source-code"><a class="header" href="#1-checkout-the-project-source-code">1. Checkout the project source code.</a></h2>
<pre><code class="language-sh">$ mkdir swiftwasm-source
$ cd swiftwasm-source
$ git clone https://github.com/swiftwasm/swiftwasm-build.git
$ cd swiftwasm-build
$ ./tools/build/install-build-sdk.sh main
$ ./tools/git-swift-workspace --scheme main
</code></pre>
<h2 id="2-install-required-dependencies"><a class="header" href="#2-install-required-dependencies">2. Install required dependencies</a></h2>
<ol>
<li><a href="https://github.com/apple/swift/blob/main/docs/HowToGuides/GettingStarted.md#installing-dependencies">Please follow the upstream instruction</a></li>
<li>(If you want to run test suite) Install <a href="https://wasmtime.dev/"><code>Wasmtime</code></a></li>
</ol>
<p>If you are using macOS, please ensure that you don‚Äôt have <code>llvm</code> package installed via Homebrew.</p>
<h2 id="3-build-the-toolchain"><a class="header" href="#3-build-the-toolchain">3. Build the toolchain</a></h2>
<p><code>./tools/build/build-toolchain.sh</code></p>
<p>This script will build the following components:</p>
<ol>
<li>Swift compiler that can compile Swift code to WebAssembly support</li>
<li>Swift standard library and core libraries for WebAssembly</li>
</ol>
<h2 id="build-on-docker"><a class="header" href="#build-on-docker">Build on Docker</a></h2>
<p>You can also build the toolchain on Docker image used in CI.
Note that you have already checked out the source code in <a href="#1-checkout-the-project-source-code">the previous step</a>.</p>
<pre><code class="language-sh">$ docker volume create oss-swift-package
$ docker run --name swiftwasm-ci-buildbot \
    -dit \
    -w /home/build-user/ \
    -v ./swiftwasm-source:/source \
    -v oss-swift-package:/home/build-user \
    ghcr.io/swiftwasm/swift-ci:main-ubuntu-20.04
$ docker exec swiftwasm-ci-buildbot /bin/bash -lc 'env; cp -r /source/* /home/build-user/; ./swiftwasm-build/tools/build/ci.sh main'
$ docker cp swiftwasm-ci-buildbot:/home/build-user/swift-wasm-DEVELOPMENT-SNAPSHOT-*-ubuntu-20.04.tar.gz .
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
